/*! gaoerjunLib 2015-08-04 */
function Game2048(){this.playing=0,this.started=0,this.Game2048over=0,this.won=0,this.m_startX=0,this.m_startY=0,this.moveX=0,this.moveY=0,this.blankArr=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16],this.init=function(){this.initEvent(),this.startGame()},this.initEvent=function(){var a=document.getElementById("canvas");a.addEventListener("touchstart",this.eventDown.pointTo(this)),a.addEventListener("touchend",this.eventUp.pointTo(this)),a.addEventListener("touchmove",this.eventMove.pointTo(this)),a.addEventListener("mousedown",this.eventDown.pointTo(this)),a.addEventListener("mouseup",this.eventUp.pointTo(this)),a.addEventListener("mousemove",this.eventMove.pointTo(this));var b=document.getElementById("restart");b.addEventListener("click",this.restartGame.pointTo(this))},this.eventDown=function(a){if(a.preventDefault(),a.targetTouches)var b=a.targetTouches[0];this.m_startX=a.clientX||a.pageX||b.pageX,this.m_startY=a.clientY||a.pageY||b.pageY,this.moveX=0,this.moveY=0},this.eventUp=function(a){if(a.preventDefault(),Math.abs(this.moveX)>Math.abs(this.moveY))this.blankArr=[],this.doMove(this.moveX>0?"right":"left");else{if(Math.abs(this.moveY)<=10)return!1;this.blankArr=[],this.doMove(this.moveY>0?"down":"up")}},this.eventMove=function(a){var b=this;if(a.preventDefault(),a.targetTouches)var c=a.targetTouches[0];var d=a.clientX||a.pageX||c.pageX,e=a.clientY||a.pageY||c.pageY;b.moveX=d-b.m_startX,b.moveY=e-b.m_startY},this.init()}$(function(){new Game2048}),Function.prototype.pointTo=function(a){var b=this;return function(){return b.apply(a,arguments)}},Game2048.prototype.startGame=function(){this.newBlock(),this.newBlock()},Game2048.prototype.doMove=function(a){for(var b=!1,c=1;4>=c;c++)this.updateLine(c,a)&&(b=!0);if(b){this.newBlock();var d=$(".count").html();d=parseInt(d,10)+3,$(".count").html(d)}else $(".err_tip").html("请换个方向移动~"),setTimeout(function(){$(".err_tip").html("")},1e3)},Game2048.prototype.newBlock=function(){var a=Math.floor(Math.random()*this.blankArr.length+1),b=this.getBlankPosByNum(this.blankArr[a-1]);this.updateBlock(b.x,b.y,Math.random()<.9?2:4),this.blankArr.splice(a-1,1),0==this.blankArr.length&&this.isFinish()&&(window.confirm("Game2048 over,是否重新开始？"),this.restartGame())},Game2048.prototype.restartGame=function(){for(var a=1;4>=a;a++)for(var b=1;4>=b;b++)this.updateBlock(a,b,0);this.blankArr=[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16],this.newBlock(),this.newBlock()},Game2048.prototype.isFinish=function(){if(this.blankArr.length>0)return!1;for(var a=!0,b=1;4>=b;b++)for(var c=1;4>=c;c++){var d=$("#"+b+"_"+c).html();if(4>b){var e=$("#"+(b+1)+"_"+c).html();if(e==d){a=!1;break}}if(4>c){var f=$("#"+b+"_"+(c+1)).html();if(f==d){a=!1;break}}}return a},Game2048.prototype.updateLine=function(a,b){var c=!1,d=[],e=4;for(("left"==b||"up"==b)&&(e=1);;){if(("left"==b||"up"==b)&&e>4)break;if(("right"==b||"down"==b)&&0>e)break;var f=$("#"+a+"_"+e);("up"==b||"down"==b)&&(f=$("#"+e+"_"+a));var g=f.html();g>0&&d.push(g),"up"==b||"left"==b?e++:e--}for(var h=0;h<d.length;h++)if(h<=d.length-2&&d[h]==d[h+1]){d[h]=parseInt(d[h],10)-0+parseInt(d[h+1],10);var i=$(".count").html();i=parseInt(i,10)+d[h],$(".count").html(i);for(var j=h+1;j<d.length;j++)j+1<=d.length-1&&(d[j]=d[j+1]);d.splice(d.length-1,1)}for(var h=d.length||0;4>h;h++)d[h]=0;if("left"==b)for(var h=1;4>=h;h++){var g=d[h-1];this.updateBlock(a,h,g)&&(c=!0)}else if("right"==b)for(var h=4;h>=1;h--){var g=d[4-h];this.updateBlock(a,h,g)&&(c=!0)}else if("up"==b)for(var h=1;4>=h;h++){var g=d[h-1];this.updateBlock(h,a,g)&&(c=!0)}else if("down"==b)for(var h=4;h>=1;h--){var g=d[4-h];this.updateBlock(h,a,g)&&(c=!0)}return c},Game2048.prototype.updateBlock=function(a,b,c){var d=$("#"+a+"_"+b),e=d.html();if(e==c||""==e&&0==c){if(0==c){var f=this.getBlankNumByPos(a,b);this.blankArr.push(f)}return!1}if(c>0)d.attr("class","i_block item"+c).html(c);else{var f=this.getBlankNumByPos(a,b);this.blankArr.push(f),d.attr("class","i_block").html("")}return!0},Game2048.prototype.getBlankNumByPos=function(a,b){for(var c=0;c<m_posMap.length;c++)if(m_posMap[c].pos==a+"_"+b)return m_posMap[c].key},Game2048.prototype.getBlankPosByNum=function(a){for(var b=0;b<m_posMap.length;b++)if(m_posMap[b].key==a){var c=m_posMap[b].pos.split("_");return{x:c[0],y:c[1]}}};